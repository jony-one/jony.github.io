<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>3. eBPF 工具链 | Jony</title>

  <link rel="shortcut icon" href="/jony.github.io/images/favicon.png">
  <link rel="alternate" href="/jony.github.io/atom.xml" title="Jony" type="application/atom+xml">
  <meta name="description" content="工具链  本节介绍 BPF 相关的用户态工具、内省设施（introspection facilities）和内核控制选项。 注意，围绕 BPF 的工具和基础设施还在快速发展当中，因此本文提供的内容可能只覆 盖了其中一部分。 Ubuntu 123$ sudo apt-get install -y make gcc libssl-dev bc libelf-dev libcap-dev \  clan">
<meta property="og:type" content="article">
<meta property="og:title" content="3. eBPF 工具链">
<meta property="og:url" content="https://jony-one.github.io/jony.github.io/e83139ad9bf1/index.html">
<meta property="og:site_name" content="Jony">
<meta property="og:description" content="工具链  本节介绍 BPF 相关的用户态工具、内省设施（introspection facilities）和内核控制选项。 注意，围绕 BPF 的工具和基础设施还在快速发展当中，因此本文提供的内容可能只覆 盖了其中一部分。 Ubuntu 123$ sudo apt-get install -y make gcc libssl-dev bc libelf-dev libcap-dev \  clan">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-24T01:59:45.000Z">
<meta property="article:modified_time" content="2021-06-17T04:38:41.175Z">
<meta property="article:author" content="Jony.Z.Y">
<meta property="article:tag" content="ebpf">
<meta name="twitter:card" content="summary">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content="">
  <meta name="keywords" content=",ebpf">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Jony">
  <meta name="msapplication-starturl" content="https://jony-one.github.io/jony.github.io/jony.github.io/e83139ad9bf1/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Jony">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/jony.github.io/images/favicon.png">

  
    <meta property="article:published_time" content="Wed Feb 24 2021 09:59:45 GMT+0800">
    <meta property="article:modified_time" content="Thu Jun 17 2021 12:38:41 GMT+0800">
  

  
    <link rel="canonical" href="https://jony-one.github.io/jony.github.io/jony.github.io/e83139ad9bf1/">
  

  
  

  
  
  

  
<link rel="stylesheet" href="/jony.github.io/css/mdui.css">
<link rel="stylesheet" href="/jony.github.io/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-indigo mdui-theme-accent-pink">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/jony.github.io/" class="mdui-typo-headline">Jony</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    <a href="/jony.github.io/atom.xml" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'RSS'}"><i class="mdui-icon material-icons">rss_feed</i></a>
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键词">
    </div>
    <div class="search-result" data-resource="/jony.github.io/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/jony.github.io/images/banner.png" style="height: 160px;">
    <img src="/jony.github.io/images/avatar.png" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">Jony.Z.Y</div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i></div>
      </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/jony.github.io/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">11</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">27</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/categories/Lord-of-the-io-uring/">Lord of the io_uring<span class="mdui-ripple sidebar_archives-count">16</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/categories/dubbo/">dubbo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/categories/eBPF/">eBPF<span class="mdui-ripple sidebar_archives-count">23</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/categories/gRPC/">gRPC<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/categories/%E5%AF%BC%E8%88%AA/">导航<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/jony.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务<span class="mdui-ripple sidebar_archives-count">7</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/CNI/" rel="tag">CNI<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/Netty/" rel="tag">Netty<span class="mdui-ripple sidebar_archives-none-count">5</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/cilium/" rel="tag">cilium<span class="mdui-ripple sidebar_archives-none-count">11</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/ebpf/" rel="tag">ebpf<span class="mdui-ripple sidebar_archives-none-count">23</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/grpc/" rel="tag">grpc<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/h2c/" rel="tag">h2c<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/http2/" rel="tag">http2<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/io-uring/" rel="tag">io_uring<span class="mdui-ripple sidebar_archives-none-count">17</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/microservices/" rel="tag">microservices<span class="mdui-ripple sidebar_archives-none-count">12</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/sofa/" rel="tag">sofa<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/tc/" rel="tag">tc<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/%E5%BC%82%E6%AD%A5/" rel="tag">异步<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务<span class="mdui-ripple sidebar_archives-none-count">2</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/%E6%97%A0%E6%9C%8D%E5%8A%A1/" rel="tag">无服务<span class="mdui-ripple sidebar_archives-none-count">2</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/" rel="tag">流量控制<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/%E7%90%86%E8%AE%BA/" rel="tag">理论<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/jony.github.io/tags/%E7%AE%97%E6%B3%95%E7%90%86%E8%A7%A3/" rel="tag">算法理解<span class="mdui-ripple sidebar_archives-none-count">1</span></a>
        
      </div>
    </div>
    <a href="/jony.github.io/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
          <a href="https://github.com/jony-one" target="_blank" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme-accent" style="justify-content: center;">Github</a>
        
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  
<link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">

  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/jony.github.io//images/random/material-2.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">3. eBPF 工具链</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2021-02-24 / <i class="iconfont">&#xe601;</i> Jony</div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#qrcode', align: 'right'}"><i class="mdui-icon material-icons">devices</i></button>
          <ul class="mdui-menu" id="qrcode">
            
              <li class="mdui-menu-item"><a class="mdui-text-center mdui-ripple">发送到我的手机</a></li>
            
            <li class="mdui-menu-item" disabled>
              
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACYElEQVR42u3aQW7DMAwEwPz/0+21h8ZZUhYjGONTgcaWxweKWOr18+jrhYeHh4eHh4eHdxjvFV/v7vqw2OW9f/+b/DJ6Nzw8PLwRXvUVE+r1S0Qlvvf58PDw8AZ5ScmuLpmX/uQ50XaCh4eHdzwvKf3JJvHuyXh4eHjP4F3fVQ0yquvi4eHhncPLW+Tr4l6NHu5q3/Hw8PAmeXlxn/97dL6Hh4eHF/B2DKV6EUPv+f+siIeHh7eZlxfi6nbSO3zQex88PDy8eV7yQkn5rkaxeUCcbyR4eHh4M7xezNrbTpLVq0M4PDw8vEneeqjaG331YuJmjIuHh4e3gZeU6bxAJ4eleqtEbT0eHh7eZl6vba2W+GpcG7XO+ckIPDw8vFt5K8cFekOy9YCjHEbg4eHhbePl7W9vSNaLcavbFR4eHt48rxooXJf16iZxw+p4eHh4m3l5cc+D1Gpz3PtMeHh4eN/i9Y4IrISz1WFbOd7Fw8PDG+ElC+eBb7555CFv4XPj4eHhbeZVx/O9oVRvYNbbHvDw8PDmefnjegV9R0CMh4eHN89bB/Ta9GRbKt+Fh4eH91XeypGp6nGE6sZQaKnx8PDwNvPy0CGPJO49ZPDh4+Lh4eFt5t074kqa4JU2OlkRDw8PbzevV+h7xT2Pj6skPDw8vHleHsLm46uV1nxpa8HDw8Mb5F0P+HvU3udbiSTw8PDwzuclC1dftHcACw8PD+98XrWUVw9v9cZpeHh4eJO8pOXtDcmqT74OefHw8PBO4K0X96WRVdx8R8cU8PDw8Dbznnfh4eHh4eHh4eEdcP0CQ1I1AEOEC00AAAAASUVORK5CYII=">
              
            </li>
          </ul>
        
        
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="mdui-icon material-icons">share</i></button>
          <ul class="mdui-menu" id="share_menu">
            <li class="mdui-menu-item">
              <a href="http://service.weibo.com/share/share.php?appkey=&title=3. eBPF 工具链&url=https://jony-one.github.io/jony.github.io/e83139ad9bf1/&pic=https://jony-one.github.io/jony.github.io/jony.github.io/images/favicon.png&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到微博</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://twitter.com/intent/tweet?text=3. eBPF 工具链&url=https://jony-one.github.io/jony.github.io/e83139ad9bf1/&via=Jony.Z.Y" target="_blank" class="mdui-ripple">分享到Twitter</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.facebook.com/sharer/sharer.php?u=https://jony-one.github.io/jony.github.io/e83139ad9bf1/" target="_blank" class="mdui-ripple">分享到Facebook</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://plus.google.com/share?url=https://jony-one.github.io/jony.github.io/e83139ad9bf1/" target="_blank" class="mdui-ripple">分享到Google+</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://jony-one.github.io/jony.github.io/e83139ad9bf1/&title=3. eBPF 工具链" target="_blank" class="mdui-ripple">分享到LinkedIn</a>
            </li>
            <li class="mdui-menu-item">
              <a href="http://connect.qq.com/widget/shareqq/index.html?site=Jony&title=3. eBPF 工具链&summary=&pics=https://jony-one.github.io/jony.github.io/jony.github.io/images/favicon.png&url=https://jony-one.github.io/jony.github.io/e83139ad9bf1/" target="_blank" class="mdui-ripple">分享到QQ</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://telegram.me/share/url?url=https://jony-one.github.io/jony.github.io/e83139ad9bf1/&text=3. eBPF 工具链" target="_blank" class="mdui-ripple">分享到Telegram</a>
            </li>
          </ul>
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1>工具链</h1>
<hr>
<p>本节介绍 BPF 相关的用户态工具、内省设施（introspection facilities）和内核控制选项。 注意，围绕 BPF 的工具和基础设施还在快速发展当中，因此本文提供的内容可能只覆 盖了其中一部分。</p>
<h3 id="Ubuntu">Ubuntu</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y make gcc libssl-dev bc libelf-dev libcap-dev \</span><br><span class="line">  clang gcc-multilib llvm libncurses5-dev git pkg-config libmnl-dev bison flex \</span><br><span class="line">  graphviz</span><br></pre></td></tr></table></figure>
<h1>2.2 LLVM</h1>
<p>写作本文时，LLVM 是唯一提供 BPF 后端的编译器套件。gcc 目前还不支持。</p>
<p>主流的发行版在对 LLVM 打包的时候就默认启用了 BPF 后端，因此，在大部分发行版上安 装 clang 和 llvm 就可以将 C 代码编译为 BPF 对象文件了。</p>
<p>典型的工作流是：</p>
<ol>
<li>用 C 编写 BPF 程序</li>
<li>用 LLVM 将 C 程序编译成对象文件（ELF）</li>
<li>用户空间 BPF ELF 加载器（例如 iproute2）解析对象文件</li>
<li>加载器通过 bpf() 系统调用将解析后的对象文件注入内核</li>
<li>内核验证 BPF 指令，然后对其执行即时编译（JIT），返回程序的一个新文件描述符</li>
<li>利用文件描述符 attach 到内核子系统（例如网络子系统）</li>
</ol>
<p>某些子系统还支持将 BPF 程序 offload 到硬件（例如网卡）。</p>
<h2 id="2-2-1-BPF-Target（目标平台）">2.2.1 BPF Target（目标平台）</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ llc --version</span><br><span class="line">LLVM (http://llvm.org/):</span><br><span class="line">LLVM version 3.8.1</span><br><span class="line">Optimized build.</span><br><span class="line">Default target: x86_64-unknown-linux-gnu</span><br><span class="line">Host CPU: skylake</span><br><span class="line"></span><br><span class="line">Registered Targets:</span><br><span class="line">  [...]</span><br><span class="line">  bpf        - BPF (host endian)</span><br><span class="line">  bpfeb      - BPF (big endian)</span><br><span class="line">  bpfel      - BPF (little endian)</span><br><span class="line">  [...]</span><br></pre></td></tr></table></figure>
<p><strong>默认情况下，bpf target 使用编译时所在的 CPU 的大小端格式</strong> ，即，如果 CPU 是小 端，BPF 程序就会用小端表示；如果 CPU 是大端，BPF 程序就是大端。这也和 BPF 的运 行时行为相匹配，这样的行为比较通用，而且大小端格式一致可以避免一些因为格式导致的 架构劣势。</p>
<p>BPF 程序可以在大端节点上编译，在小端节点上运行，或者相反，因此对于 <strong>交叉编译</strong> ， 引入了两个新目标 <code>bpfeb</code> 和 <code>bpfel</code>。注意前端也需要以相应的大小端方式运行。</p>
<p>在不存在大小端混用的场景下，建议使用 bpf target。例如，在 x86_64 平台上（小端 ），指定 bpf 和 bpfel 会产生相同的结果，因此触发编译的脚本不需要感知到大小端 。</p>
<p>下面是一个最小的完整 XDP 程序，实现丢弃包的功能（xdp-example.c）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __section</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __section(NAME)                  \</span></span><br><span class="line">   __attribute__((section(NAME), used))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">__section(<span class="string">&quot;prog&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">xdp_drop</span><span class="params">(struct xdp_md *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> __license[] __section(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>用下面的命令编译并加载到内核：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ clang -O2 -Wall -target bpf -c xdp-example.c -o xdp-example.o</span><br><span class="line">$ ip link <span class="built_in">set</span> dev em1 xdp obj xdp-example.o</span><br></pre></td></tr></table></figure>
<pre><code># 注意
以上命令将一个 XDP 程序 attach 到一个网络设备，需要是 Linux 4.11 内核中支持 XDP 的设备，或者 4.12+ 版本的内核。
</code></pre>
<p>LLVM（&gt;= 3.9） 使用正式的 BPF 机器值（machine value），即 EM_BPF（十进制 247 ，十六进制 0xf7），来生成对象文件。在这个例子中，程序是用 bpf target 在 x86_64 平台上编译的，因此下面显示的大小端标识是 LSB (和 MSB 相反)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file xdp-example.o</span><br><span class="line">xdp-example.o: ELF 64-bit LSB relocatable, *unknown arch 0xf7* version 1 (SYSV), not stripped</span><br></pre></td></tr></table></figure>
<p><code>readelf -a xdp-example.o</code> 能够打印 ELF 文件的更详细信息，有时在检查生成的 section header、relocation entries 和符号表时会比较有用。</p>
<hr>
<h1>2.2.2 调试信息（<a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a>、BTF）</h1>
<p>若是要 debug，clang 可以生成下面这样的汇编器输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ clang -O2 -S -Wall -target bpf -c xdp-example.c -o xdp-example.S</span><br><span class="line">$ cat xdp-example.S</span><br><span class="line">    .text</span><br><span class="line">    .section    prog,<span class="string">&quot;ax&quot;</span>,@progbits</span><br><span class="line">    .globl      xdp_drop</span><br><span class="line">    .p2align    3</span><br><span class="line">xdp_drop:                             <span class="comment"># @xdp_drop</span></span><br><span class="line"><span class="comment"># BB#0:</span></span><br><span class="line">    r0 = 1</span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">    .section    license,<span class="string">&quot;aw&quot;</span>,@progbits</span><br><span class="line">    .globl    __license               <span class="comment"># @__license</span></span><br><span class="line">__license:</span><br><span class="line">    .asciz    <span class="string">&quot;GPL&quot;</span></span><br></pre></td></tr></table></figure>
<p>LLVM 从 6.0 开始，还包括了汇编解析器（assembler parser）的支持。你可以直接使用 BPF 汇编指令编程，然后使用 llvm-mc 将其汇编成一个目标文件。例如，你可以将前面 的 xdp-example.S 重新变回对象文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ llvm-mc -triple bpf -filetype=obj -o xdp-example.o xdp-example.S</span><br></pre></td></tr></table></figure>
<h1><a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 格式和 llvm-objdump</h1>
<p>另外，较新版本（&gt;= 4.0）的 LLVM 还可以将调试信息以 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">dwarf</a> 格式存储到对象文件中。 只要在编译时加上 -g：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ clang -O2 -g -Wall -target bpf -c xdp-example.c -o xdp-example.o</span><br><span class="line">$ llvm-objdump -S -no-show-raw-insn xdp-example.o</span><br><span class="line"></span><br><span class="line">xdp-example.o:        file format ELF64-BPF</span><br><span class="line"></span><br><span class="line">Disassembly of section prog:</span><br><span class="line">xdp_drop:</span><br><span class="line">; &#123;</span><br><span class="line">    0:        r0 = 1</span><br><span class="line">; <span class="built_in">return</span> XDP_DROP;</span><br><span class="line">    1:        <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p>llvm-objdump 工具能够用编译的 C 源码对汇编输出添加注解（annotate ）。这里 的例子过于简单，没有几行 C 代码；但注意上面的 0 和 1 行号，这些行号直接对 应到内核的校验器日志（见下面的输出）。这意味着假如 BPF 程序被校验器拒绝了， llvm-objdump能帮助你将 BPF 指令关联到原始的 C 代码，对于分析来说非常有用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ip link <span class="built_in">set</span> dev em1 xdp obj xdp-example.o verb</span><br><span class="line"></span><br><span class="line">Prog section <span class="string">&#x27;prog&#x27;</span> loaded (5)!</span><br><span class="line"> - Type:         6</span><br><span class="line"> - Instructions: 2 (0 over <span class="built_in">limit</span>)</span><br><span class="line"> - License:      GPL</span><br><span class="line"></span><br><span class="line">Verifier analysis:</span><br><span class="line"></span><br><span class="line">0: (b7) r0 = 1</span><br><span class="line">1: (95) <span class="built_in">exit</span></span><br><span class="line">processed 2 insns</span><br></pre></td></tr></table></figure>
<p>从上面的校验器分析可以看出，llvm-objdump 的输出和内核中的 BPF 汇编是相同的。</p>
<p>去掉 -no-show-raw-insn 选项还可以以十六进制格式在每行汇编代码前面打印原始的 struct bpf_insn：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ llvm-objdump -S xdp-example.o</span><br><span class="line"></span><br><span class="line">xdp-example.o:        file format ELF64-BPF</span><br><span class="line"></span><br><span class="line">Disassembly of section prog:</span><br><span class="line">xdp_drop:</span><br><span class="line">; &#123;</span><br><span class="line">   0:       b7 00 00 00 01 00 00 00     r0 = 1</span><br><span class="line">; <span class="built_in">return</span> foo();</span><br><span class="line">   1:       95 00 00 00 00 00 00 00     <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<h3 id="LLVM-IR">LLVM IR</h3>
<p>对于 LLVM IR 调试，BPF 的编译过程可以分为两个步骤：首先生成一个二进制 LLVM IR 临 时文件 xdp-example.bc，然后将其传递给 <code>llc</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ clang -O2 -Wall -target bpf -emit-llvm -c xdp-example.c -o xdp-example.bc</span><br><span class="line">$ llc xdp-example.bc -march=bpf -filetype=obj -o xdp-example.o</span><br></pre></td></tr></table></figure>
<p>生成的 LLVM IR 还可以 dump 成人类可读的格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang -O2 -Wall -emit-llvm -S -c xdp-example.c -o -</span><br></pre></td></tr></table></figure>
<h2 id="BTF">BTF</h2>
<p>LLVM 能将调试信息（例如对程序使用的数据的描述）attach 到 BPF 对象文件。默认情况 下使用 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 格式。</p>
<p>BPF 使用了一个高度简化的版本，称为 <strong>BTF</strong> (BPF Type Format)。生成的 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 可以 转换成 BTF 格式，然后通过 BPF 对象加载器加载到内核。内核验证 BTF 数据的正确性， 并跟踪 BTF 数据中包含的数据类型。</p>
<p>这样的话，就可以用键和值对 BPF map 打一些注解（annotation）存储到 BTF 数据中，这 样下次 dump map 时，除了 map 内的数据外还会打印出相关的类型信息。这对内省（ introspection）、调试和格式良好的打印都很有帮助。注意，BTF 是一种通用的调试数据 格式，因此任何从 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 转换成的 BTF 数据都可以被加载（例如，内核 vmlinux <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 数 据可以转换成 BTF 然后加载）。后者对于未来 BPF 的跟踪尤其有用。</p>
<p>将 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 格式的调试信息转换成 BTF 格式需要用到 <code>elfutils</code> (&gt;= 0.173) 工具。 如果没有这个工具，那需要在 <code>llc</code> 编译时打开 <code>-mattr=[dwarf](http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction)ris</code> 选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ llc -march=bpf -mattr=<span class="built_in">help</span> |&amp; grep [dwarf](http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/<span class="comment">#bpf_instruction)ris</span></span><br><span class="line">[dwarf](http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/<span class="comment">#bpf_instruction)ris - Disable MCAsmInfo [Dwarf](http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction)UsesRelocationsAcrossSections.</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<p>使用 -mattr=<a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">dwarf</a>ris 是因为 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">dwarf</a>ris (<a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">dwarf</a> relocation in section) 选项禁 用了 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 和 ELF 的符号表之间的 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> cross-section 重定位，因为 libdw 不支持 BPF 重定位。不打开这个选项的话，pahole 这类工具将无法正确地从对象中 dump 结构。</p>
<p>elfutils (&gt;= 0.173) 实现了合适的 BPF 重定位，因此没有打开 -mattr=<a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">dwarf</a>ris 选 项也能正常工作。它可以从对象文件中的 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 或 BTF 信息 dump 结构。目前 pahole 使用 LLVM 生成的 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 信息，但未来它可能会使用 BTF 信息。</p>
<h2 id="pahole-注：pahole-一种代码审计工具">pahole (注：pahole 一种代码审计工具)</h2>
<p>将 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 转换成 BTF 格式需要使用较新的 pahole 版本（&gt;= 1.12），然后指定 -J 选项。 检查所用的 pahole 版本是否支持 BTF（注意，pahole 会用到 llvm-objcopy，因此 也要检查后者是否已安装）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pahole --<span class="built_in">help</span> | grep BTF</span><br><span class="line">-J, --btf_encode           Encode as BTF</span><br></pre></td></tr></table></figure>
<p>生成调试信息还需要前端的支持，在 clang 编译时指定 -g 选项，生成源码级别的调 试信息。注意，不管 llc 是否指定了 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">dwarf</a>ris 选项，-g 都是需要指定的。生成目 标文件的完整示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ clang -O2 -g -Wall -target bpf -emit-llvm -c xdp-example.c -o xdp-example.bc</span><br><span class="line">$ llc xdp-example.bc -march=bpf -mattr=[dwarf](http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/<span class="comment">#bpf_instruction)ris -filetype=obj -o xdp-example.o</span></span><br></pre></td></tr></table></figure>
<p>或者，只使用 clang 这一个工具来编译带调试信息的 BPF 程序（同样，如果有合适的 elfutils 版本，<a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">dwarf</a>ris 选项可以省略）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang -target bpf -O2 -g -c -Xclang -target-feature -Xclang +[dwarf](http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/<span class="comment">#bpf_instruction)ris -c xdp-example.c -o xdp-example.o</span></span><br></pre></td></tr></table></figure>
<p>基于 <a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 信息 dump BPF 程序的数据结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ pahole xdp-example.o</span><br><span class="line">struct xdp_md &#123;</span><br><span class="line">        __u32                      data;                 /*     0     4 */</span><br><span class="line">        __u32                      data_end;             /*     4     4 */</span><br><span class="line">        __u32                      data_meta;            /*     8     4 */</span><br><span class="line"></span><br><span class="line">        /* size: 12, cachelines: 1, members: 3 */</span><br><span class="line">        /* last cacheline: 12 bytes */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在对象文件中，<a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">DWARF</a> 数据将仍然伴随着新加入的 BTF 数据一起保留。完整的 clang 和 pahole 示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ clang -target bpf -O2 -Wall -g -c -Xclang -target-feature -Xclang +[dwarf](http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/<span class="comment">#bpf_instruction)ris -c xdp-example.c -o xdp-example.o</span></span><br><span class="line">$ pahole -J xdp-example.o</span><br></pre></td></tr></table></figure>
<h2 id="readelf">readelf</h2>
<p>通过 readelf 工具可以看到多了一个 .BTF section：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -a xdp-example.o</span><br><span class="line">[...]</span><br><span class="line">  [18] .BTF              PROGBITS         0000000000000000  00000671</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<p>BPF 加载器（例如 iproute2）会检测和加载 BTF section，因此给 BPF map 注释（ annotate）类型信息。</p>
<h3 id="2-2-3-BPF-指令集">2.2.3 BPF 指令集</h3>
<pre><code>根据不同的 CPU 生成不同的汇编指令，用于编译和执行
</code></pre>
<p>LLVM 默认用 BPF 基础指令集（base instruction set）来生成代码，以确保这些生成的对<br>
象文件也能够被稍老的 LTS 内核（例如 4.9+）加载。</p>
<p>但是，LLVM 提供了一个 BPF 后端选项 <code>-mcpu</code>，可以指定不同版本的 BPF 指令集，即<br>
BPF 基础指令集之上的指令集扩展（instruction set extensions），以生成更高效和体积<br>
更小的代码。</p>
<p>可用的 <code>-mcpu</code> 类型：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> llc -march bpf -mcpu=<span class="built_in">help</span></span></span><br><span class="line">Available CPUs for this target:</span><br><span class="line"></span><br><span class="line">  generic - Select the generic processor.</span><br><span class="line">  probe   - Select the probe processor.</span><br><span class="line">  v1      - Select the v1 processor.</span><br><span class="line">  v2      - Select the v2 processor.</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>generic</code> processor 是默认的 processor，也是 BPF <code>v1</code> 基础指令集。</li>
<li><code>v1</code> 和 <code>v2</code> processor 通常在交叉编译 BPF 的环境下比较有用，即编译 BPF 的平台<br>
和最终执行 BPF 的平台不同（因此 BPF 内核特性可能也会不同）。</li>
</ul>
<p><strong>推荐使用 <code>-mcpu=probe</code> ，这也是 Cilium 内部在使用的类型</strong>。使用这种类型时，<br>
LLVM BPF 后端会向内核询问可用的 BPF 指令集扩展，如果找到可用的，就会使用相应的指<br>
令集来编译 BPF 程序。</p>
<p>使用 <code>llc</code> 和 <code>-mcpu=probe</code> 的完整示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> clang -O2 -Wall -target bpf -emit-llvm -c xdp-example.c -o xdp-example.bc</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> llc xdp-example.bc -march=bpf -mcpu=probe -filetype=obj -o xdp-example.o</span></span><br></pre></td></tr></table></figure>
<p><a name="ch_2.2.4"></a></p>
<h3 id="2-2-4-指令和寄存器位宽（64-32-位）">2.2.4 指令和寄存器位宽（64/32 位）</h3>
<p>通常来说，LLVM IR 生成是架构无关的。但使用 <code>clang</code> 编译时是否指定 <code>-target bpf</code><br>
是有几点小区别的，取决于不同的平台架构（<code>x86_64</code>、<code>arm64</code> 或其他），<code>-target</code> 的<br>
默认配置可能不同。</p>
<p>引用内核文档 <code>Documentation/bpf/bpf_devel_QA.txt</code>：</p>
<ul>
<li>
<p>BPF 程序可以嵌套 include 头文件，只要头文件中都是文件作用域的内联汇编代码（<br>
file scope inline assembly codes）。大部分情况下默认 target 都可以处理这种情况，<br>
但如果 BPF 后端汇编器无法理解这些汇编代码，那 <code>bpf</code> target 会失败。</p>
</li>
<li>
<p>如果编译时没有指定 <code>-g</code>，那额外的 elf sections（例如 <code>.eh_frame</code><br>
和 <code>.rela.eh_frame</code>）可能会以默认 target 格式出现在对象文件中，但不会是 <code>bpf</code><br>
target。</p>
</li>
<li>
<p>默认 target 可能会将一个 C <code>switch</code> 声明转换为一个 <code>switch</code> 表的查找和跳转操作。<br>
由于 switch 表位于全局的只读 section，因此 BPF 程序的加载会失败。 <code>bpf</code> target<br>
不支持 switch 表优化。clang 的 <code>-fno-jump-tables</code> 选项可以禁止生成 switch 表。</p>
</li>
<li>
<p>如果 clang 指定了 <code>-target bpf</code>，那指针或 <code>long</code>/<code>unsigned long</code> 类型将永远<br>
是 64 位的，不管底层的 clang 可执行文件或默认的 target（或内核）是否是 32<br>
位。但如果使用的是 native clang target，那 clang 就会根据底层的架构约定（<br>
architecture’s conventions）来编译这些类型，这意味着对于 32 位的架构，BPF 上下<br>
文中的指针或 <code>long</code>/<code>unsigned long</code> 类型会是 32 位的，但此时的 BPF LLVM 后端仍<br>
然工作在 64 位模式。</p>
</li>
</ul>
<p><code>native</code> target 主要用于跟踪（tracing）内核中的 <code>struct pt_regs</code>，这个结构体对<br>
CPU 寄存器进行映射，或者是跟踪其他一些能感知 CPU 寄存器位宽（CPU’s register<br>
width）的内核结构体。除此之外的其他场景，例如网络场景，都建议使用 <code>clang -target bpf</code>。</p>
<p>另外，LLVM 从 7.0 开始支持 32 位子寄存器和 BPF ALU32 指令。另外，新加入了一个代<br>
码生成属性 <code>alu32</code>。当指定这个参数时，LLVM 会尝试尽可能地使用 32 位子寄存器，例<br>
如当涉及到 32 位操作时。32 位子寄存器及相应的 ALU 指令组成了 ALU32 指令。例如，<br>
对于下面的示例代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat 32-bit-example.c</span></span><br><span class="line">void cal(unsigned int *a, unsigned int *b, unsigned int *c)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int sum = *a + *b;</span><br><span class="line">  *c = sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用默认的代码生成选项，产生的汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ clang -target bpf -emit-llvm -S 32-bit-example.c</span><br><span class="line">$ llc -march&#x3D;bpf 32-bit-example.ll</span><br><span class="line">$ cat 32-bit-example.s</span><br><span class="line">cal:</span><br><span class="line">  r1 &#x3D; *(u32 *)(r1 + 0)</span><br><span class="line">  r2 &#x3D; *(u32 *)(r2 + 0)</span><br><span class="line">  r2 +&#x3D; r1</span><br><span class="line">  *(u32 *)(r3 + 0) &#x3D; r2</span><br><span class="line">  exit</span><br></pre></td></tr></table></figure>
<p>可以看到默认使用的是 <code>r</code> 系列寄存器，这些都是 64 位寄存器，这意味着其中的加法都<br>
是 64 位加法。现在，如果指定 <code>-mattr=+alu32</code> 强制要求使用 32 位，生成的汇编代码<br>
如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ llc -march&#x3D;bpf -mattr&#x3D;+alu32 32-bit-example.ll</span><br><span class="line">$ cat 32-bit-example.s</span><br><span class="line">cal:</span><br><span class="line">  w1 &#x3D; *(u32 *)(r1 + 0)</span><br><span class="line">  w2 &#x3D; *(u32 *)(r2 + 0)</span><br><span class="line">  w2 +&#x3D; w1</span><br><span class="line">  *(u32 *)(r3 + 0) &#x3D; w2</span><br><span class="line">  exit</span><br></pre></td></tr></table></figure>
<p>可以看到这次使用的是 <code>w</code> 系列寄存器，这些是 32 位子寄存器。</p>
<p>使用 32 位子寄存器可能会减小（最终生成的代码中）<strong>类型扩展指令</strong>（type extension<br>
instruction）的数量。另外，它对 32 位架构的内核 eBPF JIT 编译器也有所帮助，因为<br>
原来这些编译器都是用 32 位模拟 64 位 eBPF 寄存器，其中使用了很多 32 位指令来操作<br>
高 32 bit。即使写 32 位子寄存器的操作仍然需要对高 32 位清零，但只要确保从 32 位<br>
子寄存器的读操作只会读取低 32 位，那只要 JIT 编译器已经知道某个寄存器的定义只有<br>
子寄存器读操作，那对高 32 位的操作指令就可以避免。</p>
<h1>文档连接</h1>
<p><a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/2019/12/10/5dee76b007da0/">Linux BPF 3.2、BPF and XDP Reference Guide</a><br>
<a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#bpf_instruction">[译] Cilium：BPF 和 XDP 参考指南（2019）</a><br>
<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/bpf/">BPF and XDP Reference Guide</a><br>
<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html">BPF 辅助函数</a><br>
<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/bpf.2.html">BPF man 文档</a></p>

      <blockquote class="mdui-m-t-5">
        
        <strong>本文链接：</strong><a href="https://jony-one.github.io/jony.github.io/e83139ad9bf1/">https://jony-one.github.io/jony.github.io/e83139ad9bf1/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/jony.github.io/categories/eBPF/">eBPF</a>
      
      
        <a class="mdui-ripple article_tags-none-link" href="/jony.github.io/tags/ebpf/" rel="tag">ebpf</a>
      
    </footer>
    
  </article>
  
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>

  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/jony.github.io/3006e0a225f3/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/jony.github.io/6b9c54247f6f/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: '1f3bd87bedab703ed26b',
    clientSecret: '7d0e550c44e851ee7d15da6e864896c0d742691b',
    repo: 'jony.github.io',
    owner: 'jony-one',
    admin: ['jony-one'],
    id: location.pathname,
    distractionFreeMode: false
  });
  gitalk.render('gitalk-container');
</script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">工具链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ubuntu"><span class="toc-number">1.0.1.</span> <span class="toc-text">Ubuntu</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">2.2 LLVM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-1-BPF-Target%EF%BC%88%E7%9B%AE%E6%A0%87%E5%B9%B3%E5%8F%B0%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">2.2.1 BPF Target（目标平台）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">2.2.2 调试信息（DWARF、BTF）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">DWARF 格式和 llvm-objdump</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LLVM-IR"><span class="toc-number">4.0.1.</span> <span class="toc-text">LLVM IR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BTF"><span class="toc-number">4.1.</span> <span class="toc-text">BTF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pahole-%E6%B3%A8%EF%BC%9Apahole-%E4%B8%80%E7%A7%8D%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7"><span class="toc-number">4.2.</span> <span class="toc-text">pahole (注：pahole 一种代码审计工具)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#readelf"><span class="toc-number">4.3.</span> <span class="toc-text">readelf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-BPF-%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-number">4.3.1.</span> <span class="toc-text">2.2.3 BPF 指令集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-%E6%8C%87%E4%BB%A4%E5%92%8C%E5%AF%84%E5%AD%98%E5%99%A8%E4%BD%8D%E5%AE%BD%EF%BC%8864-32-%E4%BD%8D%EF%BC%89"><span class="toc-number">4.3.2.</span> <span class="toc-text">2.2.4 指令和寄存器位宽（64&#x2F;32 位）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">文档连接</span></a></li></ol></li>
    </ul>
  </div>
</main>
  <footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2020 - 2021 Jony.Z.Y<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>
    
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  
  
<script src="/jony.github.io/js/mdui.js"></script>
<script src="/jony.github.io/js/script.js"></script>

</body>
</html>