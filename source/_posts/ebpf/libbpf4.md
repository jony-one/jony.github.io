---
title: 用ebpf编写XDP网络过滤器 译
date: 2021-06-14 19:44:19
categories: 
	- [eBPF]
tags:
  - ebpf
  - cilium
author: Jony
---

# 用ebpf编写XDP网络过滤器 
原文:[https://duo.com/labs/tech-notes/writing-an-xdp-network-filter-with-ebpf](https://duo.com/labs/tech-notes/writing-an-xdp-network-filter-with-ebpf)

在2019年Kubecon大会上，有很多很棒的演讲提到eBPF是一种非常强大的工具，用于监控、创建审计跟踪，甚至高性能网络。Cilium的一个演讲描述了eBPF和XDP如何将Kubernetes从iptables中解放出来，这个演讲非常有趣，因为我们当时正在探索Kubernetes和Istio。仅仅因为这听起来像是一种非常棒的技术，我们便花了一些侧循环去提升我们对于eBPF如何工作以及它可以在何处使用的理解。
在本文中，我将更多地关注XDP，而不是通用的eBPF。与可以监视系统的大多数eBPF使用相比，使用XDP实际上可以在包进入系统的早期时刻修改原始网络流量，甚至在内核有机会处理它们之前。支持“Offloaded”XDP的网卡甚至可以在网卡硬件本身上运行XDP应用程序并处理数据包，而CPU甚至看不到它!太酷了!


XDP是eXpress Data Path的缩写，它在Linux内核中提供了一个高性能的数据路径，用于在网络数据包到达网卡时进行处理。本质上，
您可以将XDP程序附加到一个网络接口上，然后每当在该接口上看到一个新包时，这些程序就会得到回调。就是这样。真正的简单。

# 案例
从小处着手总是好的。对于这个实验，我想从一个可以改变一些东西的程序开始，但是要小，容易测试和可视化。为此，我选择了将UDP数据包的dest端口从7999更改为7998的简单问题。

这很容易可视化和测试。打开3台终端，分别执行如下2条命令:

`nc -kul 127.0.0.1 7999`

`nc -kul 127.0.0.1 7998`

这些终端就是我们的监听过程。我们正在使用nc netcat打开一个套接字，侦听udp数据包进入端口7999和7998的127.0.0.1地址。
参数-k只是告诉netcat在收到一个数据包后继续监听，这样它就可以从其他客户端接收更多的数据包。

在第三个终端中，运行:

然后在下一行中，键入一些文本，后跟 `<Enter>`。您应该会看到在第一个终端，监听端口7999中回响的文本。一旦我们将XDP应用程序安装到位，
    连接到lo环回设备，数据包将在路由中被修改，并转移到监听端口7998的另一个终端。