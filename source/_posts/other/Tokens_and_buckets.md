---
title: 流量控制：令牌和桶算法
date: 2021-02-26 11:14:23
categories: 
	- [eBPF]
tags:
  - ebpf
  - tc
  - 流量控制
  - 算法理解
author: Jony

---

# 流量控制：令牌和桶算法

流量整形的两个关键要素就是**令牌**和**桶**

为了控制流量的进出流量，一种方式是直接哦统计队列中出出队列的报文和字节数，但是为了保证精确性就需要复杂的计算。在流量控制中广泛应用的另一种方式就是令牌桶，令牌桶以一定的速率产生令牌，报文或字节出队时从令牌桶中取令牌，只有取到令牌后才能出队。

举个例子更加抽象的理解：
一群人正排队等待乘坐游乐场的游览车。想象一下现在有一条固定的道路，游览车以固定的速度抵达，每个人都必须等待游览车到达后才能乘坐。游览车和游客就可以抽象为令牌或者报文，这种机制就是速率限制或流量整形，在一个固定的时间段内只有一部分人能乘坐游览车。

继续上面的比方，设想有大量的游览车正停在车站等待游客乘坐，但现在没有一个游客。如果突然有一大群游客同时过来了（高并发），那么他们都可以马上乘上游览车。在这里，我们就可以将车站类比为桶，一个桶中包含一定数量的令牌，桶中的令牌可以一次性被使用完而不管数据包到达的时间。

让我们来完成这个比方，游览车以固定的速率抵达车站，如果没人乘坐就会停满车站，即令牌以一定的速率进入桶中，如果令牌一直没被使用那么桶就可以被装满，而如果令牌不断的被使用那么桶就不会满。令牌桶是处理会产生流量突发应用（比如HTTP）的关键思想。

使用令牌桶过滤器的排队规则（TBF qdisc，Token Bucket Filter）是流量整形的一个经典例子。TBF以**给定的速度**产生令牌，当桶中有令牌时才发送数据，令牌是整流的基本思想。

在某些情况下，队列中可能无数据包，因此不会立即需要令牌，这些令牌就会被**收集起来**直到队列需要。但无限制的积累令牌可能会**失去流量整形**的意义，所以令牌积累到一定量就会**停止**。由于积累了令牌，当有大量的报文或字节需要出队时就有足够的令牌可用。这种虚拟的令牌被存储在虚拟的桶中，一个桶中能存放多少令牌取决于桶的大小。

这意味着如果桶的大小设计不合理，在任何时刻桶中都可能充满令牌。**小型的令牌桶适合流量较为稳定的网络，大型的令牌桶适合有较大突发流量的网络**，除非你的目的就是为了限制数据流的突发传输。

总之，令牌以固定的速度产生，桶中可以积满令牌，这样就可以处理突发流量，使网络流量更为平滑。

令牌和桶的概念紧密相联，它们被用于TBF(一种无类qdiscs)和HTB（一种分类qdiscs）中。在tcng语言中，二色和三色标识法就是令牌桶的应用。
下面参考图看下：
![Token Bucket Filter](/jony.github.io/images/tbf-qdisc.png)

---


# 参考连接
[Linux流量控制指南](https://blog.csdn.net/zgangz/article/details/42737871)
[Traffic Control HOWTO](https://tldp.org/HOWTO/html_single/Traffic-Control-HOWTO/)